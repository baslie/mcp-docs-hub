---
title: Генерируем ответ на базе документов (RAG)
source_url: https://developers.sber.ru/docs/ru/salutebot/scenario/blocks/ai-answer
tags: [Graph, Code]
---

# Генерируем ответ на базе документов (RAG)

Блок **AI-ответ из базы знаний** дает пользователям ответ, который генерируется нейросетью GigaChat. Ответ выдается на конкретном шаге сценария и генерируется на базе информации из загруженных документов.
Вы можете продолжать использовать GigaChat Lite при работе с блоками **Генерация ответа** и **AI-ответ из базы знаний** на бесплатной основе.  
Также в проекте SaluteBot появилась возможность получить и добавить свои персональные [ключи GigaChat](https://developers.sber.ru/docs/ru/salutebot/gigachat-key).
Если вы используете персональные ключи авторизации GigaChat, то для работы с RAG обязательно подключите модель векторного представления текста [Embeddings](https://developers.sber.ru/docs/ru/gigachat/guides/embeddings). Без подключенной модели база знаний работать не будет.
**Важно** : в базе знаний на платформе SaluteBot используется только модель **Embeddings**. Для работы с RAG обязательно выберите [глобальный ключ](https://developers.sber.ru/docs/ru/salutebot/gigachat-key#dobavlenie-globalnogo-klyucha).
Graph
Code
Для получения ответа из базы знаний:
  1. Откройте раздел **Сценарий**.
  2. Выберите шаг, на котором требуется выполнить поиск в базе знаний.
  3. Добавьте блок **AI-ответ из базы знаний**.
  4. Заполните необходимые параметры блока. Описание параметров приведено ниже.
  5. Нажмите **Сохранить**.

Для блока в сценарии настроены переходы:
  * **Успешный ответ** — если ответ был найден в документах (переход `okState`).
  * **Ответ не найден** — если в документах не было найдено подходящего ответа (переход `noMatchState`).

**Параметры блока**
**Сборка и внедрение**
Для настройки работы базы знаний возможно выбрать один из двух режимов:
  * **Собрать** — в этом случае будет выполнена сборка без внедрения базы знаний документов. Включено по умолчанию, если ответ пустой и в списке нет ни одной базы знаний.
  * **Собрать и внедрить** — все обученные документы будут внедрены и выполнится сборка. Включено по умолчанию, если в списке есть база знаний.

**Настройка приоритета срабатывания**
Для настройки случаев, когда должна срабатывать база знаний, укажите **Приоритет срабатывания** в разделе **Настройки базы знаний**.
  * **Высокий** — найденные ответы из базы знаний по документам срабатывают в первую очередь, при этом если в документах не найдено ничего подходящего, должны проверяться варианты по интентам, примерам и паттернам.
  * **Низкий** — найденные ответы из базы знаний по документам срабатывают только в том случае, если не найдено подходящих вариантов по интентам, примерам или паттернам.
  * **Только блок AI-Ответ из базы знаний** — обращение в базу знаний сработает, если в сценарную логику добавлен этот блок. При использовании этого блока рекомендуется установить приоритет **Только блок AI-Ответ из базы знаний**. При использовании других приоритетов возможно срабатывание базы знаний при фразе пользователя в каком-либо ином блоке.

Вы можете повысить качество работы чат-бота, используя [настройки модели GigaChat](https://developers.sber.ru/docs/ru/salutebot/gigachatsettings).
Для получения ответа из базы знаний:
  1. Откройте раздел **Редактор**.
  2. Выберите стейт, на котором требуется выполнить поиск в базе знаний.
  3. Добавьте функцию `$llm.agentQnAFindAnswer`, которая выполняет запрос в GigaChat.
  4. Для этой функции укажите список id-моделей документов, по которым будет выполняться поиск.

В результате обработки функции будет получен успешный или не успешный ответ. Полученный успешный ответ будет отправлен пользователю.
Возвращаемый объект имеет следующие поля:
Пример использования в сценарии:
```
state: noMatch  
    event!: noMatch  
script:  
var systemContent ="Отвечай в стиле крокодила Гены из мультика "Чебурашка";  
var userContent = $request.query;  
var modelSettings ={"model":"GigaChat-2-Max","temperature":0.5,"maxTokens":512,"repetitionPenalty":1,"topP":0.1}  
        $llm.fetchRequest({"systemContent": systemContent,"userContent": $request.query,"noHistory":true,"llmModelSettings": $modelSettings })  
.then(function(response){  
if(response.isOk){  
                    $reaction.answer(response.message);  
}else{  
                    $reactions.transition('/transwerToOperator');  
}  
                $jsapi.log("### log: "+toPrettyString($temp.answer));  
});  

```

Подробная информация о параметрах GigaChat - в разделе [Настраиваем параметры GigaChat](https://developers.sber.ru/docs/ru/salutebot/gigachatsettings).
**Список возвращаемых статусов ошибок**
Код ошибки и сообщение о ней сохраняются в системные переменные.