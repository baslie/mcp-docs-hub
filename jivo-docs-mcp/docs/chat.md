---
title: Chat API
source_url: https://www.jivo.ru/docs/chat/
---

# Chat API

В этой памятке описан способ обмена событиями между серверами по Chat-каналу при интеграции с [Jivo](https://www.jivo.ru/). Чат API канал асинхронный двунаправленный, для полной реализации необходим пользовательский сервер, способный принимать и отправлять события.

## Протокол канала

Транспортным протоколом для передачи событий является [HTTPS](https://wikipedia.org/wiki/HTTP) (на этапе разработки допускается использовать [HTTP](https://wikipedia.org/wiki/HTTP)). Событие содержится в теле [POST](https://wikipedia.org/wiki/POST_(HTTP))-запроса в формате [JSON](https://www.json.org/) (кодировка текста в этом формате - [UTF-8](https://wikipedia.org/wiki/UTF-8)), запрос должен иметь соответствующий заголовок `Content-Type: application/json; charset=utf-8`. Структура событий описана [далее](chat.md#%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0-%D1%81%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D0%B9). Варианты ответов делятся на 3 группы по HTTP-коду ответа.

| Название | Тип | Описание |
| --- | --- | --- |
| [2xx](https://wikipedia.org/wiki/List_of_HTTP_status_codes#2xx_success) | Успех. Событие принято в обработку | Сообщить пользователю об успехе доставки |
| [4xx](https://wikipedia.org/wiki/List_of_HTTP_status_codes#4xx_client_errors) | Ошибка запроса. Событие отклонено | В теле ответа с таким кодом, может быть текст описания ошибки (тип содержимого Content-Type: text/plain; charset=utf-8). Повторно отправлять это событие не следует. Необходим анализ и исправление ошибки программы или настроек канала. Информировать пользователя об ошибке доставки события |
| Любой другой HTTP-код или ошибка подключения | Принять запрос невозможно в данный момент. Событие не принято | В случае HTTP-кода [5xx](https://wikipedia.org/wiki/List_of_HTTP_status_codes#5xx_server_errors) или при неудачном подключении, рекомендуется повторить запрос до 3х раз с промежутком 3-60 секунд. Информировать пользователя о временной невозможности доставки события. Связаться с поддержкой сервера |

## Создание канала

Для создания Chat-канала в Jivo следует использовать [приложение](https://app.jivosite.com/). После создания станет доступен [URL](https://wikipedia.org/wiki/URL) для отправки событий в Jivo, например: `https://joint.jivo.ru/IF6Y*****************B`. Для приема сообщений от Jivo необходимо реализовать пользовательский сервер и добавить URL, на который он будет принимать события, в настройки канала в приложении.

## Статус канала

Если к URL для отправки событий в Jivo добавить в конце пути сегмент `/status`, например `https://joint.jivo.ru/IF6Y*****************B`, то в теле ответа (при успешном овете с кодом `2xx`) на [GET](https://wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods)-запрос по полученному URL будет статус канала, означающий отсутствие собеседников на канале когда ответ `0`, либо наличие собеседников при ответе `1` или любом другом.

## Структура событий

Протокол симметричный, структура одинакова для событий от Jivo к пользовательскому серверу и обратно.

| Название | Тип | Описание |
| --- | --- | --- |
| sender | [User](chat.md#User) | Отправитель сообщения |
| recipient | [User](chat.md#User) | Получатель сообщения |
| message | [Message](chat.md#Message) | Сообщение |

### User

| id | string | Идентификатор клиента, обязательный параметр при отправке событий в Jivo sender.id и при получении событий от Jivo recipient.id | 255 символов |
| --- | --- | --- | --- |
| name | string | Имя пользователя | 255 символов |
| photo | string | URL аватара пользователя, допустимые схемы https или http | 2048 символов |
| url | string | URL страницы пользователя, допустимые схемы https или http | 2048 символов |
| email | string | Электронная почта пользователя | 255 символов |
| phone | string | Телефонный номер пользователя | 2-15 символов |
| invite | string | Текст приглашения клиента | 1000 символов |
| group | string | Отдел, в который обращается клиент | 10 цифр |
| intent | string | Тема обращения клиента | 255 символов |
| crm_link | string | URL клиента в CRM-системе | 2048 символов |

### Message

| type | string | Тип сообщения, обязательный параметр | Ограничен допустимыми значениями, варианты смотреть в таблице |
| --- | --- | --- | --- |
| id | string | Идентификатор сообщения, необходим если требуется изменить статус сообщения после его отправки | 500 символов |
| date | number | Время создания/отправки сообщения, целое число | Ограничено разумными пределами величины UNIX-время |
| file | string | URL медиа-данных | 2048 символов, допустимая схема https или http |
| thumb | string | URL изображения предварительного просмотра для медиа-данных | 2048 символов, допустимая схема https или http |
| file_size | number | Размер медиа-данных в октетах (байтах) | Целое положительное число, ограничено возможностями клиентских приложений |
| width | number | Ширина изображения или видео в пикселах | Целое положительное число, ограничено возможностями клиентских приложений |
| height | number | Высота изображения или видео в пикселах | Целое положительное число, ограничено возможностями клиентских приложений |
| file_name | string | Имя файла медиа-данных | 255 символов, возможна несовместимость с устаревшими файловыми системами! |
| mime_type | string | MIME-тип медиа-данных | Ограничено списком допустимых значений |
| text | string | Текст сообщения | Рекомендуется ограничить длину 1000 символов, при превышении, остатки текста будут досланы отдельными текстовыми сообщениями |
| title | string | Заголовок сообщения | 255 символов |
| latitude | number | Широта местоположения, вещественное число | от -90.0000 до +90.0000 |
| longitude | number | Долгота местоположения, вещественное число | от -180.0000 до +180.0000 |
| value | number | Число, обычно используется в оценке чата | любое число |
| keyboard | []Key | Массив структур Key | 7 клавиш |
| multiple | boolean | Допустимость множественного выбора на клавиатуре, логическое | true или false |

### Keyboard

Отправка клавиатуры с вариантами ответов. Для корректной работы необходима поддержка этого типа событий со стороны клиента. Обязательным для клавиши является наличие одного поля структуры, как в запросе `keyboard,` так и в ответе. Подробнее в [примере](chat.md#%D0%BA%D0%BB%D0%B0%D0%B2%D0%B8%D0%B0%D1%82%D1%83%D1%80%D0%B0-%D1%81-%D0%B2%D0%B0%D1%80%D0%B8%D0%B0%D0%BD%D1%82%D0%B0%D0%BC%D0%B8-%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%BE%D0%B2). Приоритет полей для отображения пользователю записан в таблице по убыванию.

| text | string | Текст клавиши | 100 символов |
| --- | --- | --- | --- |
| image | string | URL изображения (схема https или http) | 2048 символов |
| title | string | Заголовок или всплывающая подсказка клавиши | 100 символов |
| id | string | Идентификатор клавиши | 500 символов |

## Типы сообщения

| Название | Тип | Описание |
| --- | --- | --- |
| text | [Текстовое сообщение](chat.md#tekstovoe-soobschenie) | text |
| photo | [Изображение](chat.md#izobrazhenie) | file |
| sticker | [Стикер](chat.md#stiker) | file |
| video | [Видео-сообщение](chat.md#video-soobschenie) | file |
| audio | [Звуковое сообщение](chat.md#zvukovoe-soobschenie) | file |
| document | [Документ или файл](chat.md#dokument-ili-fayl), в сообщении этого типа можно отправлять любые файлы, разрешенные для передачи в Jivo. | file |
| location | [Местоположение](chat.md#mestopolozhenie) | latitudelongitude |
| rate | [Оценка чата](chat.md#otsenka-chata) | value |
| seen | [Событие прочтения сообщения](chat.md#sobytie-prochteniya-soobscheniya), в поле id необходимо указать идентификатор прочитанного сообщения | id |
| keyboard | [Клавиатура с вариантами ответов](chat.md#klaviaturas-variantami-otvetov), подробности в примере | keyboard |
| typein | [Событие о наборе текста](chat.md#sobytie-o-nabore-teksta), в поле text этого сообщения можно записать набранный текст, чтобы он был виден пользователю Jivo. Отправлять это событие не чаще 1 раза в 5 секунд от одного клиента | - |
| start | [Начало чата](chat.md#nachalo-chata), предназначено для возобновления чата после команды stop без отправки сообщения клиентом | - |
| stop | [Завершение чата](chat.md#zavershenie-chata), сигнал о том, что события по этому клиенту больше не принимаются | - |

## Примеры событий

### Пример события от Jivo

Если для пользователя Jivo определено хоть одно свойство отправителя, в событие добавляется поле `sender` с этой информацией. Получатель сообщения идентифицируется полем `recipient.id`.

```json
{
   "sender": {
      "id": "XXX",
      "name": "Консультант",
      "photo": "https://example.com/avatar.png",
      "email": "info@jivosite.com"
   },
   "recipient": {
      "id": "001"
   },
   "message": {
      "type": "text",
      "id":   "0000",
      "date": 946684800,
      "text": "Добрый день!"
   }
}
```

### Клавиатура с вариантами ответов

Клавиатура может быть отправлена только от пользователя Jivo к клиенту:

```json
{
   "recipient": {
      "id": "001"
   },
   "message": {
      "type":     "keyboard",
      "id":       "0009",
      "title":    "Опрос",
      "text":     "Быть или не быть?",
      "multiple": false,
      "keyboard": [
         {
            "id": "1",
            "text": "да"
         },
         {
            "id": "2",
            "text": "нет"
         },
         {
            "id": "X",
            "text": "надо подумать..."
         }
      ]
   }
}
```

Ожидается, что ответом клиента на такое сообщение будет один элемент из массива `keyboard`, если `multiple != true`:

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":     "keyboard",
      "id":       "0009",
      "multiple": false,
      "keyboard": [
         {
            "id": "X",
            "text": "надо подумать..."
         }
      ]
   }
}
```

или несколько, в случае `multiple = true`.

Если клиентское приложение не поддерживает клавиатуру с вариантами ответов, рекомендуется преобразовать этот тип сообщения в текстовый список для отображения клиенту, например:

```
Опрос

Быть или не быть?
   1) да
   2) нет
   X) надо подумать...
```

Ответом на сообщение `keyboard` может быть текстовое сообщение, например:

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":  "text",
      "text":  "надо подумать..."
   }
}
```

Далее следуют примеры событий для отправки в Jivo.

### Начало чата

При первом событии от клиента, рекомендуется заполнить структуру `sender`. Далее, достаточно поля `sender.id`, а остальные поля этой структуры можно заполнять только при их изменении.

```json
{
   "sender": {
      "id":     "001",
      "name":   "Иван Иванович",
      "photo":  "https://example.com/me.jpg",
      "url":    "https://example.com/",
      "phone":  "+7(958)100-32-91",
      "email":  "me@example.com",
      "invite": "Здравствуйте! Могу вам чем то помочь?"
   },
   "message": {
      "type": "start"
   }
}
```

### Текстовое сообщение

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type": "text",
      "id":   "0001",
      "date": 946684800,
      "text": "Добрый день!"
   }
}
```

### Изображение

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":      "photo",
      "id":        "0002",
      "date":      946684800,
      "file":      "https://example.com/image.png",
      "mime_type": "image/png",
      "file_name": "image.png",
      "file_size": 1024,
      "thumb":     "https://example.com/image_thumb.png",
      "width":     800,
      "height":    600,
      "title":     "Заголовок",
      "text":      "Комментарий к изображению."
   }
}
```

### Стикер

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":      "sticker",
      "id":        "0003",
      "date":      946684800,
      "file":      "https://example.com/sticker.gif",
      "mime_type": "image/gif",
      "file_name": "sticker.gif",
      "file_size": 1024,
      "width":     256,
      "height":    256
   }
}
```

### Видео-сообщение

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":      "video",
      "id":        "0004",
      "date":      946684800,
      "file":      "https://example.com/video.mp4",
      "mime_type": "video/mp4",
      "file_name": "video.mp4",
      "file_size": 1048576,
      "thumb":     "https://example.com/video_thumb.png",
      "width":     640,
      "height":    480,
      "title":     "Заголовок",
      "text":      "Комментарий к видео."
   }
}
```

### Звуковое сообщение

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":      "audio",
      "id":        "0005",
      "date":      946684800,
      "file":      "https://example.com/audio.mp3",
      "mime_type": "audio/mpeg",
      "file_name": "audio.mp3",
      "file_size": 2048,
      "title":     "Заголовок",
      "text":      "Комментарий к звуковому сообщению."
   }
}
```

### Документ или файл

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":      "document",
      "id":        "0006",
      "date":      946684800,
      "file":      "https://example.com/document.pdf",
      "mime_type": "application/pdf",
      "file_name": "document.pdf",
      "file_size": 512,
      "title":     "Заголовок",
      "text":      "Комментарий к документу."
   }
}
```

### Местоположение

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":      "location",
      "id":        "0007",
      "date":      946684800,
      "text":      "Это тут.",
      "latitude":  53.3416484,
      "longitude": -6.2868531
   }
}
```

### Оценка чата

На данный момент используются 3 варианта значения поля `value`: 0 интерпретируется как отказ оценивать, положительное число - положительная оценка, отрицательное число - отрицательная оценка чата.

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type":  "rate",
      "id":    "0008",
      "value": 1
   }
}
```

### Событие о наборе текста

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type": "typein",
      "text": "Подождите мину"
   }
}
```

### Событие прочтения сообщения

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type": "seen",
      "id":   "0001"
   }
}
```

### Завершение чата

```json
{
   "sender": {
      "id": "001"
   },
   "message": {
      "type": "stop"
   }
}
```

## Решение проблем

При обнаружении неточностей в этой памятке, либо при ее несоответствии действительности, просьба сообщить в чат поддержки [Jivo](https://www.jivo.ru/) или на [email](mailto:info@jivosite.com?subject=Chat%20API).